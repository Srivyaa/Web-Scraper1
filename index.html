<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MassTamilan → RadioBrowser JSON</title>
  <style>
    body{font-family:Segoe UI,Arial;background:#0a0a0a;color:#0f0;margin:40px;}
    h1{font-size:2.5rem;margin:0 0 20px;}
    button{padding:15px 30px;font-size:1.3rem;background:#0f0;color:#000;border:none;border-radius:8px;cursor:pointer;}
    button:hover{background:#0c0;}
    button:disabled{background:#333;opacity:0.6;cursor:not-allowed;}
    .bar{background:#222;border:2px solid #0f0;border-radius:8px;height:30px;margin:20px 0;overflow:hidden;}
    .fill{background:#0f0;height:100%;width:0%;transition:width .3s;}
    pre{background:#000;padding:15px;border:2px solid #0f0;border-radius:8px;max-height:70vh;overflow:auto;font-size:1rem;}
    .dl{margin-top:15px;}
  </style>
</head>
<body>
  <h1>MassTamilan → RadioBrowser JSON</h1>
  <button id="start">Extract ALL Songs NOW</button>
  
  <div class="bar"><div class="fill" id="fill"></div></div>
  <div id="status">Ready – click the button!</div>
  
  <pre id="out"></pre>
  
  <div class="dl">
    <button id="download" style="display:none;">Download JSON File</button>
  </div>

<script>
const startBtn = document.getElementById('start');
const fill = document.getElementById('fill');
const status = document.getElementById('status');
const out = document.getElementById('out');
const dlBtn = document.getElementById('download');
let finalJSON = null;

startBtn.onclick = async () => {
  startBtn.disabled = true;
  dlBtn.style.display = 'none';
  out.textContent = '';
  status.textContent = 'Fetching homepage...';
  fill.style.width = '0%';
  
  try {
    // 1. Load homepage
    const homeHTML = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://www.masstamilan.dev/')).then(r=>r.text());
    const homeDoc = new DOMParser().parseFromString(homeHTML, 'text/html');
    
    // 2. Find all song pages
    const pageLinks = [...homeDoc.querySelectorAll('a[href]')]
      .map(a => a.href)
      .filter(h => h.includes('.html') || h.match(/\/\d{4}\//))
      .map(h => new URL(h, 'https://www.masstamilan.dev/').href);
    
    const pages = [...new Set(pageLinks)];
    if (!pages.length) throw 'No song pages found!';
    
    status.textContent = `Found ${pages.length} pages. Scraping MP3s...`;
    
    const songs = [];
    let done = 0;
    
    for (const page of pages) {
      try {
        const pageHTML = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(page)).then(r=>r.text());
        const doc = new DOMParser().parseFromString(pageHTML, 'text/html');
        const mp3s = doc.querySelectorAll('a[href$=".mp3"], a[href$=".MP3"]');
        
        for (const a of mp3s) {
          const url = new URL(a.href, page).href;
          const title = (a.textContent || '').trim() || decodeURIComponent(url.split('/').pop().replace(/\.(mp3|MP3)$/i,''));
          songs.push({title, url});
        }
      } catch(e) {}
      
      done++;
      const percent = Math.round((done / pages.length) * 100);
      fill.style.width = percent + '%';
      status.textContent = `Progress: ${done}/${pages.length} pages → ${songs.length} songs`;
    }
    
    if (!songs.length) throw 'No MP3 links found!';
    
    // 4. Build JSON
    const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
      const r=Math.random()*16|0,v=c=='x'?r:r&3|8;return v.toString(16);
    });
    const now = new Date().toISOString();
    const nowPlain = now.slice(0,19).replace('T',' ');
    
    finalJSON = songs.map(s => ({
      "changeuuid": uuid(),
      "stationuuid": uuid(),
      "serveruuid": uuid(),
      "name": s.title,
      "url": s.url,
      "url_resolved": s.url,
      "homepage": "https://www.masstamilan.dev",
      "favicon": "https://www.masstamilan.dev/favicon.ico",
      "tags": "Tamil,MassTamilan,Latest",
      "country": "India",
      "countrycode": "IN",
      "iso_3166_2": "",
      "state": "Tamil Nadu",
      "language": "Tamil",
      "languagecodes": "ta",
      "votes": 0,
      "lastchangetime": nowPlain,
      "lastchangetime_iso8601": now,
      "codec": "MPEG",
      "bitrate": 0,
      "file_name_from_url": s.url.split('/').pop(),
      "hls": 0,
      "lastcheckok": 1,
      "lastchecktime": nowPlain,
      "lastchecktime_iso8601": now,
      "lastcheckoktime": nowPlain,
      "lastcheckoktime_iso8601": now,
      "lastlocalchecktime": nowPlain,
      "lastlocalchecktime_iso8601": now,
      "clicktimestamp": nowPlain,
      "clicktimestamp_iso8601": now,
      "clickcount": 0,
      "clicktrend": 0,
      "ssl_error": 0,
      "geo_lat": null,
      "geo_long": null,
      "geo_distance": null,
      "has_extended_info": false
    }));
    
    // 5. Show result
    out.textContent = JSON.stringify(finalJSON, null, 2);
    status.textContent = `DONE! ${finalJSON.length} Tamil songs ready!`;
    fill.style.width = '100%';
    dlBtn.style.display = 'inline-block';
    
  } catch(e) {
    status.textContent = 'Error: ' + e;
    out.textContent = 'Try again or check if masstamilan.dev is online.';
  } finally {
    startBtn.disabled = false;
  }
};

// Download button
dlBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(finalJSON, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `masstamilan-radio-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
